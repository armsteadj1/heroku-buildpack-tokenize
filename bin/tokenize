#!/usr/bin/env ruby

def self.app_port
  Integer(ENV['PORT']) + 1
end

def self.start_app
  fork do
    cmd = "PORT=#{app_port} #{ARGV.join(' ').sub(/#{ENV['PORT']}/, app_port.to_s)}"
    puts "buildpack=tokenize at=start-app cmd=#{cmd}"
    exec cmd
  end
end

def self.start_em_proxy
  fork do
    print_verbosely = ENV['EM_PROXY_VERBOSE'] == 'true'
    cmd = "bundle exec em-proxy -l #{ENV['PORT']} -r '127.0.0.1:#{app_port}' #{print_verbosely && '-v'} 2>&1 | sed -u 's/^/em-proxy: /g'"
    puts "buildpack=tokenize at=start-em-proxy cmd=#{cmd}"
    exec cmd
  end
end

app_pid      = start_app
em_proxy_pid = start_em_proxy

process_name = \
  case Process.wait
  when app_pid
    Process.kill('INT', em_proxy_pid)
    'app'
  when em_proxy_pid
    Process.kill('INT', app_pid)
    'em-proxy'
  end

puts "buildpack=tokenize at=exit process=#{process_name}"
exit 1